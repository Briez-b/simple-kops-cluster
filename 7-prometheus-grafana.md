## Kubernetes monitoring using Prometheus & Grafana

**Why monitoring is required**? 
The reasons is because when we have a lot of kubernetes cluster, or one cluster is used by multiple teams, it is hard to monitor everything.

So that is why we have such tools like Prometheus and Grafana (visualisation tool).

>Prometheus is an open-source monitoring and alerting toolkit, widely used for Kubernetes environments. It collects metrics from applications and systems, stores them in a time-series database, and allows powerful querying with PromQL (Prometheus Query Language). In a Kubernetes cluster, Prometheus can monitor the performance and health of containers, pods, nodes, and other components, giving detailed insights into the infrastructureâ€™s state. It typically works in conjunction with **Grafana** for visualizations and Alertmanager for handling alerts. Prometheus is highly scalable and supports service discovery, making it ideal for dynamic cloud-native environments like Kubernetes. 

What are the components of Prometheus:

![](https://github.com/Briez-b/DevOpsNotes/blob/main/Attachments/Pasted%20image%2020241008003359.png)

1. **Service Discovery:**
   - **Kubernetes / file_sd**: Prometheus uses service discovery mechanisms to dynamically find targets to scrape for metrics. In Kubernetes, Prometheus can automatically discover services, pods, or nodes. The `file_sd` refers to service discovery based on static configuration files.

2. **Prometheus Server:**
   - **Retrieval**: This component pulls metrics from various jobs or exporters using the defined targets.
   - **TSDB (Time Series Database)**: Stores the metrics collected by Prometheus. It is optimized for high performance and efficient storage of time-series data.
   - **HTTP Server**: The interface through which users interact with Prometheus, such as querying data or monitoring the health of Prometheus itself.
   - **Node/HDD/SSD**: Metrics data is stored locally on nodes or storage devices.

3. **Pushgateway:**
   - Handles metrics from short-lived jobs that may terminate before Prometheus scrapes them. These jobs push metrics to the Pushgateway, which then makes them available for Prometheus.

4. **Alertmanager:**
   - This component is responsible for handling alerts generated by Prometheus. It receives alerts, deduplicates, groups them, and sends notifications through different channels like **PagerDuty**, **Email**, etc.

5. **Prometheus Web UI**:
   - A user interface for directly querying Prometheus via **PromQL** (Prometheus Query Language) to visualize metrics data.

6. **Grafana**:
   - A popular tool used for building dashboards and visualizing metrics data. It integrates with Prometheus to offer a more polished and user-friendly experience.

7. **API Clients**:
   - External clients can interact with Prometheus through APIs to extract or manage metrics.

8. **Prometheus Targets**:
   - These represent the jobs/exporters from which Prometheus pulls metrics. Exporters expose metrics in a format that Prometheus understands.

## PRACTICE:

I already have my previous kubernetes cluster. 
### Let's install Prometheus using helm:

![](https://github.com/Briez-b/DevOpsNotes/blob/main/Attachments/Pasted%20image%2020241008011330.png)

After helm install command there is important info written, so pay attention to it when you will be using it.

Now I have new pods running:
![](https://github.com/Briez-b/DevOpsNotes/blob/main/Attachments/Pasted%20image%2020241008011555.png)

kube-state-metrics is ussualy not installed by default. But we use helm chart who installs it.
This controller adds more metrics to monitor our cluster. By default Kubernetes API provides us not so many metrics.

And we have such services:

![](https://github.com/Briez-b/DevOpsNotes/blob/main/Attachments/Pasted%20image%2020241008012350.png)

We need to expose prometheus-server by making it NodePort mode. It can be done by `kubectl expose service`. With this command we create a new service, based on other, but with NodePort type:

![](https://github.com/Briez-b/DevOpsNotes/blob/main/Attachments/Pasted%20image%2020241008013225.png)

Now I am able to connect to this service through browser. Just need to add inbound rule for this port:

![](https://github.com/Briez-b/DevOpsNotes/blob/main/Attachments/Pasted%20image%2020241008014227.png)

Now using node public IP and port I can access Prometheus server:

![](https://github.com/Briez-b/DevOpsNotes/blob/main/Attachments/Pasted%20image%2020241008014312.png)

Now we can write Prometheus queries to get needed metrics. By default we can get only metrics that kubernetes provides. If we want more, we can add them by adding libraries and etc. with metrics.

### Install Graphana

![](https://github.com/Briez-b/DevOpsNotes/blob/main/Attachments/Pasted%20image%2020241008015112.png)

And generate password with the command above.

![](https://github.com/Briez-b/DevOpsNotes/blob/main/Attachments/Pasted%20image%2020241008015225.png)

Next expose Grafana service as well:

![](https://github.com/Briez-b/DevOpsNotes/blob/main/Attachments/Pasted%20image%2020241008015614.png)

Add new inbound rule for this port as well and now i can access it:

![](https://github.com/Briez-b/DevOpsNotes/blob/main/Attachments/Pasted%20image%2020241008015814.png)

Add Prometheus as data source to Grafana:

![](https://github.com/Briez-b/DevOpsNotes/blob/main/Attachments/Pasted%20image%2020241008042001.png)

Now I can create Dashboards. Let's import some existing one:

![](https://github.com/Briez-b/DevOpsNotes/blob/main/Attachments/Pasted%20image%2020241008042300.png)

Choose our Prometheus, and it is ready.

![](https://github.com/Briez-b/DevOpsNotes/blob/main/Attachments/Pasted%20image%2020241008042411.png)

All this info provided by prometheus queries. We can create our own dashboards and elements of it by writing queries.
The info of this dashboard is limited to the metrics of kubernetes. That is why we can use additional metrics provided by `prometheus-kube-state-metrics` service added with helm installation. Let's expose it too.

![](https://github.com/Briez-b/DevOpsNotes/blob/main/Attachments/Pasted%20image%2020241008043658.png)

![](https://github.com/Briez-b/DevOpsNotes/blob/main/Attachments/Pasted%20image%2020241008043722.png)

We can see a lot of new metrics we can use with prometheus queries. For example: 

![](https://github.com/Briez-b/DevOpsNotes/blob/main/Attachments/Pasted%20image%2020241008044142.png)

Now we can add these metrics to prometheus with `kubectl edit cm prometheus-server`. There we can add new job and provide this IpAddress  to watch these metrics. 






---

### In real productions it is better to create ingresses for that.
I created ingress: 

![](https://github.com/Briez-b/DevOpsNotes/blob/main/Attachments/Pasted%20image%2020241008025239.png)

I had some problems with path as grafana and prometheus adds their own prefixes. So I used this "PathPrefixStrip".
I don't like this solution much as I had to use /login and / instead /grafana and /prometheus. But I didn't find better solution yet.
But after I logged in, I had problems again.

I tried nginx controller again (before I had problems with it, but now it works fine). Nginx controller has annotation I can add to ingress,
like `nginx.ingress.kubernetes.io/rewrite-target: /`.

![](https://github.com/Briez-b/DevOpsNotes/blob/main/Attachments/Pasted%20image%2020241008031700.png)

And I added this Class name to my Ingress. Now it works, my services accessible.

![](https://github.com/Briez-b/DevOpsNotes/blob/main/Attachments/Pasted%20image%2020241008031816.png)

But again, I have problem with pathes: It seems rewrite-target rewrite any path I wrote after /, even /demo rewritten after I add it.

I tried such thing: 

![](https://github.com/Briez-b/DevOpsNotes/blob/main/Attachments/Pasted%20image%2020241008040336.png)

With such config, it should work like this(from https://github.com/kubernetes/ingress-nginx/blob/main/docs/examples/rewrite/README.md):
For example, the ingress definition above will result in the following rewrites:

- `mypath/something` rewrites to `mypath/`
- `mypath/something/` rewrites to `mypath/`
- `mypath/something/new` rewrites to `mypath/new`
But it doesn't help. I can see it works like this, but still have a problem.

So I just left "/" for grafana. Now it is accessible with http://aa5e9d486796e46209faa48be021e226-1885885305.eu-central-1.elb.amazonaws.com/
